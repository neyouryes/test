<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ne, Coffee Fitting Test</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#3B2A22; --ink-2:#5A4034; --accent:#6A4B3B;
  --surface:rgba(255,255,255,.92); --border:#E7DED6;
}
*{box-sizing:border-box}
body{
  font-family:'Noto Serif KR', serif;
  color:var(--ink); line-height:1.7; letter-spacing:.1px;
  background:#f7f2ef; margin:0; font-size:16px;
}
.wrap{max-width:860px;margin:0 auto;padding:0 16px 72px}

/* 배너 */
.banner{position:relative;margin:0 -16px 12px;aspect-ratio:16/5;border-radius:16px;overflow:hidden;background:#000}
.banner img{width:100%;height:100%;object-fit:cover;display:block;opacity:.82}
.banner img.fade-in{opacity:0;transition:opacity .4s ease}
.banner img.fade-in.loaded{opacity:.82}
.banner-text{position:absolute;bottom:14px;left:16px;display:flex;flex-direction:column;gap:2px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35)}
.banner-top{font-weight:700;font-size:1.6rem;line-height:1.2}
.banner-bottom{font-size:0.9rem;opacity:.9}

/* 카드 */
.card{background:var(--surface);border-radius:16px;box-shadow:0 10px 30px rgba(59,42,34,.18);padding:18px;margin-top:10px;border:1px solid var(--border)}
.title{margin:6px 0 4px;font-size:1.38rem;font-weight:700}

/* 설명 2줄 */
.desc{
  margin:0 0 12px;
  color:var(--ink-2);
  font-size:1rem;
  line-height:1.9;
  letter-spacing:.1px;
}
.desc .desc-line{display:inline}

/* 문항 공통 */
.q{padding:12px 0;border-top:1px dashed var(--border)}
.q:first-child{border-top:0}
.q-title{font-size:1.06rem;margin:4px 0 8px;font-weight:700}
.opts{display:grid;gap:8px}
.opt{position:relative}
.opt input{position:absolute;opacity:0;pointer-events:none}
.opt label{
  display:block;background:#fff;border:1.5px solid var(--border);border-radius:12px;padding:10px 12px;cursor:pointer;
  transition:box-shadow .15s ease,border-color .15s ease,transform .05s ease;
}
.opt label:active{transform:scale(.995)}
.opt input:checked + label{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,75,59,.12) inset}

/* Q1: 두 타입 × 2줄 레이아웃 */
.mbti-rows { display: grid; gap: 12px; }
.mbti-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
.pair { 
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px; 
  border: 1px dashed var(--border); border-radius: 10px; padding: 10px; background: #fff;
}
.pair-legend { grid-column: 1 / -1; font-size: .85rem; color: var(--ink-2); margin: -2px 0 4px; }
@media (min-width: 560px){ .mbti-row { grid-template-columns: 1fr 1fr; } }
/* MBTI 구분 텍스트(E / I, N / S 등)를 가로 한 줄로 */
.pair-legend {
  grid-column: 1 / -1;
  font-size: .85rem;
  color: var(--ink-2);
  margin: 0 0 6px;
  text-align: center;
  white-space: nowrap; /* 줄바꿈 방지 */
}
/* Q3: 색상 그라데이션 바 */
.gradient-bar {
  position: relative; height: 40px; border-radius: 10px; overflow: hidden;
  background: linear-gradient(to right,#F5E08C,#F9D28E,#F6B48F,#E6A18F,#F28C8C,#C3A6E8,#C9A588,#B58C8C);
  display:flex; margin-top:10px;
}
.gradient-bar label{flex:1; cursor:pointer; position:relative}
.gradient-bar input{display:none}
.gradient-bar span{display:block; width:100%; height:100%}
.gradient-bar input:checked + span{outline:3px solid var(--accent); outline-offset:-3px; border-radius:4px}

/* 제출 바 */
.submitbar{position:sticky;bottom:0;margin-top:12px;z-index:20}
.submitcard{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(59,42,34,.18)}
.progress{flex:1;height:8px;background:#efe6de;border-radius:999px;overflow:hidden;position:relative}
.progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#3b2a22);transition:width .3s ease}
.btn{border:0;border-radius:12px;padding:10px 14px;font-size:.95rem;cursor:pointer;color:#fff;background:linear-gradient(180deg,#3b2a22,#2c1f19)}
.btn[disabled]{opacity:.55;cursor:not-allowed}

/* 결과 모달 & 카드 */
.result{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.result.show{display:flex}
.result-card{max-width:760px;width:100%;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden;position:relative}
.result-body{padding:20px 16px;color:#2a1d18}
.result-title{font-size:1.52rem;margin:2px 0 8px;font-weight:800;text-align:center;letter-spacing:.2px}
.combo-title{font-size:1.02rem;color:#6a4b3b;margin:10px auto 8px;font-weight:600;text-align:center;line-height:1.9}
.emoji-line{text-align:center;font-size:1.38rem;margin:8px 0 14px}
.bean-cards{display:flex;flex-direction:column;gap:12px;margin-top:4px}
.bean{
  border:1px solid var(--border);border-radius:14px;padding:12px 12px;background:#fefcfa;
}
.bean-title{font-weight:700;font-size:1rem;margin:0 0 4px}
.bean-note{font-size:0.94rem;margin:0;color:#5A4034}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle;transform:translateY(-1px)}
.method-text{margin-top:16px;font-size:1rem;font-weight:600;color:#3b2a22;text-align:center;line-height:1.9}

/* 텍스트 링크 라인 */
.actions-line{margin-top:14px;text-align:center;color:var(--ink-2);user-select:none}
.actions-line a{color:var(--accent);text-decoration:none;padding:0 8px;cursor:pointer;font-size:.98rem}
.actions-line a:hover,.actions-line a:focus{text-decoration:underline;outline:none}

/* 포커스 보조 */
.opt input:focus-visible + label, .gradient-bar input:focus-visible + span, .actions-line a:focus-visible{
  outline:3px solid var(--accent); outline-offset:2px; border-radius:6px;
}

@media (prefers-reduced-motion: reduce) {
  * { animation-duration:.001ms !important; animation-iteration-count:1 !important; transition:none !important; }
}

@media (max-width:560px){
  body{font-size:14.5px}
  .result-title{font-size:1.36rem}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="banner">
    <img id="bannerImg" src="banner1.jpg" alt="네,커피 — 취향에 맞는 원두를 찾아주는 핏팅 테스트 배너">
    <div class="banner-text">
      <div class="banner-top">Ne, Coffee Fitting Test</div>
      <div class="banner-bottom">네,커피 핏팅 테스트</div>
    </div>
  </div>

  <div class="card">
    <h1 class="title">네,커피 핏팅 테스트</h1>
    <!-- 설명 2줄 -->
    <p class="desc">
      <span class="desc-line">5가지 질문에 답하면,</span><br>
      <span class="desc-line">당신에게 어울리는 원두 조합과 마시는 방식이 제안됩니다.</span>
    </p>

    <form id="quiz">
      <!-- Q1. MBTI (두 타입 × 2줄 레이아웃) -->
      <section class="q" aria-labelledby="q1-label">
        <div id="q1-label" class="q-title">Q1. 나의 MBTI는?</div>

        <div class="mbti-rows">
          <!-- 줄 1: EI / NS -->
          <div class="mbti-row">
            <fieldset class="pair" role="radiogroup" aria-label="외향/내향">
              <legend class="pair-legend">E / I</legend>
              <div class="opt"><input id="ei-e" type="radio" name="mbti-ei" value="E"><label for="ei-e">E (외향)</label></div>
              <div class="opt"><input id="ei-i" type="radio" name="mbti-ei" value="I"><label for="ei-i">I (내향)</label></div>
            </fieldset>
            <fieldset class="pair" role="radiogroup" aria-label="직관/감각">
              <legend class="pair-legend">N / S</legend>
              <div class="opt"><input id="ns-n" type="radio" name="mbti-ns" value="N"><label for="ns-n">N (직관)</label></div>
              <div class="opt"><input id="ns-s" type="radio" name="mbti-ns" value="S"><label for="ns-s">S (감각)</label></div>
            </fieldset>
          </div>

          <!-- 줄 2: FT / JP -->
          <div class="mbti-row">
            <fieldset class="pair" role="radiogroup" aria-label="감정/사고">
              <legend class="pair-legend">F / T</legend>
              <div class="opt"><input id="ft-f" type="radio" name="mbti-ft" value="F"><label for="ft-f">F (감정)</label></div>
              <div class="opt"><input id="ft-t" type="radio" name="mbti-ft" value="T"><label for="ft-t">T (사고)</label></div>
            </fieldset>
            <fieldset class="pair" role="radiogroup" aria-label="계획/인식">
              <legend class="pair-legend">J / P</legend>
              <div class="opt"><input id="jp-j" type="radio" name="mbti-jp" value="J"><label for="jp-j">J (계획)</label></div>
              <div class="opt"><input id="jp-p" type="radio" name="mbti-jp" value="P"><label for="jp-p">P (인식)</label></div>
            </fieldset>
          </div>
        </div>
      </section>

      <!-- Q2. 향미 -->
      <section class="q" aria-labelledby="q2-label">
        <div id="q2-label" class="q-title">Q2. 내가 끌리는 커피의 향미는?</div>
        <div class="opts">
          <div class="opt"><input id="q2-1" type="radio" name="q2" value="AG"><label for="q2-1">묵직하고 진한 로스티드 풍미</label></div>
          <div class="opt"><input id="q2-2" type="radio" name="q2" value="BH"><label for="q2-2">고소하고 따뜻한 달콤함</label></div>
          <div class="opt"><input id="q2-3" type="radio" name="q2" value="CF"><label for="q2-3">상큼하고 활력 넘치는 과일향</label></div>
          <div class="opt"><input id="q2-4" type="radio" name="q2" value="DE"><label for="q2-4">섬세하고 특별한 꽃/스파이시 향</label></div>
        </div>
      </section>

      <!-- Q3. 색상 -->
      <section class="q" aria-labelledby="q3-label">
        <div id="q3-label" class="q-title">Q3. 내가 좋아하는 커피의 색감은?</div>
        <div class="gradient-bar" role="radiogroup" aria-labelledby="q3-label">
          <label><input type="radio" name="q3" value="E" aria-label="밝은 꿀빛 계열"><span></span></label>
          <label><input type="radio" name="q3" value="C" aria-label="연한 카라멜톤"><span></span></label>
          <label><input type="radio" name="q3" value="A" aria-label="살구빛 로스티"><span></span></label>
          <label><input type="radio" name="q3" value="F" aria-label="웜 로즈톤"><span></span></label>
          <label><input type="radio" name="q3" value="D" aria-label="핑크빛 베리톤"><span></span></label>
          <label><input type="radio" name="q3" value="B" aria-label="라일락 초콜릿톤"><span></span></label>
          <label><input type="radio" name="q3" value="G" aria-label="고동 계열"><span></span></label>
          <label><input type="radio" name="q3" value="H" aria-label="다크 카카오톤"><span></span></label>
        </div>
      </section>

      <!-- Q4. 기분 -->
      <section class="q" aria-labelledby="q4-label">
        <div id="q4-label" class="q-title">Q4. 지금의 나와 가까운 기분은?</div>
        <div class="opts">
          <div class="opt"><input id="q4-1" type="radio" name="q4" value="AD"><label for="q4-1">강렬한 집중과 에너지가 필요해요</label></div>
          <div class="opt"><input id="q4-2" type="radio" name="q4" value="BG"><label for="q4-2">사랑과 위로가 필요해요</label></div>
          <div class="opt"><input id="q4-3" type="radio" name="q4" value="CE"><label for="q4-3">차분한 휴식과 여유가 필요해요</label></div>
          <div class="opt"><input id="q4-4" type="radio" name="q4" value="FH"><label for="q4-4">활력과 달콤한 기분 전환이 필요해요</label></div>
        </div>
      </section>

      <!-- Q5. 방식 성향 -->
      <section class="q" aria-labelledby="q5-label">
        <div id="q5-label" class="q-title">Q5. 커피를 즐길 때 나는?</div>
        <div class="opts">
          <div class="opt"><input id="m1" type="radio" name="method" value="M1"><label for="m1">진하고 오래 가는 힘으로 집중을 원해요</label></div>
          <div class="opt"><input id="m2" type="radio" name="method" value="M2"><label for="m2">향미를 섬세하게 음미하고 싶어요</label></div>
          <div class="opt"><input id="m3" type="radio" name="method" value="M3"><label for="m3">달콤하고 시원한 전환이 필요해요</label></div>
        </div>
      </section>

      <div class="submitbar">
        <div class="submitcard">
          <div class="progress" aria-live="polite"><span id="prog"></span></div>
          <button id="submit" class="btn" type="button" disabled>결과 보기</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- 결과 모달 -->
<div id="result" class="result" role="dialog" aria-modal="true" aria-labelledby="combo-title">
  <div class="result-card" id="resultCard">
    <div class="result-body">
      <!-- 타이틀 -->
      <h2 id="combo-title" class="result-title"></h2>

      <!-- MBTI 가독성 2줄 -->
      <p id="mbti-line" class="combo-title"></p>

      <!-- 이모지 라인 -->
      <div id="emoji-line" class="emoji-line"></div>

      <!-- 원두 카드 -->
      <div id="bean-cards" class="bean-cards"></div>

      <!-- 방식 문구 (2줄) -->
      <p id="method-text" class="method-text"></p>

      <!-- 상단: 네,커피 바로 가기 -->
      <nav class="actions-line" aria-label="상단 링크">
        | <a id="goLink" href="https://linktr.ee/Ne.coffee" target="_blank" rel="noopener">네,커피 바로 가기</a> |
      </nav>

      <!-- 하단: 다시/공유/닫기 -->
      <nav class="actions-line" aria-label="결과 작업">
        | <a id="again" href="#">다시 하기</a> |
        <a id="share" href="#">공유하기</a> |
        <a id="close" href="#">닫기</a> |
      </nav>
    </div>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ===== 데이터 세트 ===== */
const TYPES={
  A:{en:"Chance",ko:"행운",cup:"캬라멜, 로스트 아몬드",emoji:"🍀",color:"#F6B48F"},
  B:{en:"Amante",ko:"연인",cup:"건자두, 레드와인",emoji:"❤️",color:"#C3A6E8"},
  C:{en:"Lune",ko:"달",cup:"홍시, 캬라멜시럽",emoji:"🌙",color:"#F9D28E"},
  D:{en:"Colombia El Diviso Washed",ko:"콜롬비아 워시드",cup:"라즈베리, 블루베리, 풍선껌",emoji:"🍓",color:"#F28C8C"},
  E:{en:"Peru El Cedro Natural",ko:"페루 내추럴",cup:"사향벌꿀, 배과즙, 시나몬",emoji:"🍯",color:"#F5E08C"},
  F:{en:"Rwanda Gitoki Washed",ko:"르완다 워시드",cup:"자두, 칵테일",emoji:"🍒",color:"#E6A18F"},
  G:{en:"Cameroon Oku Natural",ko:"카메룬 내추럴",cup:"군밤, 찐고구마",emoji:"🌰",color:"#C9A588"},
  H:{en:"Ethiopia Aricha Washed",ko:"에티오피아 워시드",cup:"다크 체리, 밀크 초콜렛",emoji:"🍫",color:"#B58C8C"}
};

const COMBO_TITLES={
  "A+B":"행운의 연인","A+C":"달빛 아래 행운","A+D":"운명의 모험","A+E":"황금빛 향연","A+F":"열정의 별빛","A+G":"따스한 행운","A+H":"달콤한 축복",
  "B+C":"달빛 로망","B+D":"사랑의 항해","B+E":"꿀처럼 달콤한 사랑","B+F":"불꽃 같은 연정","B+G":"포근한 약속","B+H":"초콜릿 키스",
  "C+D":"달과 열정의 여정","C+E":"달빛의 향기","C+F":"달의 불꽃","C+G":"따뜻한 달빛","C+H":"달밤의 속삭임",
  "D+E":"과일빛 연가","D+F":"별빛 열정","D+G":"모험의 기억","D+H":"베리의 서정",
  "E+F":"꿀빛 불꽃","E+G":"황금빛 온기","E+H":"달콤한 서약",
  "F+G":"캠프파이어 로망스","F+H":"칵테일 키스",
  "G+H":"겨울밤의 고백"
};

/* MBTI 문구 2줄 */
const MBTI_TEMP={
  ISTJ:{line1:"질서 속의 평온,", line2:"따뜻한 컵이 하루를 단단하게 해줄 거예요.", temp:"hot"},
  ISFJ:{line1:"조용한 배려에 어울리는 온기,", line2:"부드럽게 스며드는 따뜻함을.", temp:"hot"},
  INFJ:{line1:"고요한 사색에 어울리는 온기,", line2:"마음을 감싸는 한 잔.", temp:"hot"},
  INTJ:{line1:"선명한 집중을 위한 따뜻함,", line2:"차분히 설계된 한 모금.", temp:"hot"},
  ISTP:{line1:"선택은 간결하게,", line2:"차갑게 깔끔한 한 잔이 딱.", temp:"ice"},
  ISFP:{line1:"감각에 스며드는 청량함,", line2:"차갑게 더 살아나는 순간들.", temp:"ice"},
  INFP:{line1:"섬세한 마음에 잔잔한 온기,", line2:"따뜻함이 오래 남아요.", temp:"hot"},
  INTP:{line1:"머릿속 흐름을 깨우는 시원함,", line2:"맑고 차가운 산뜻함.", temp:"ice"},
  ESTP:{line1:"지금 이 순간,", line2:"차갑게 터지는 리듬으로 속도를 올려요.", temp:"ice"},
  ESFP:{line1:"반짝이는 오늘,", line2:"시원함이 더 빛나게 해줄 거예요.", temp:"ice"},
  ENFP:{line1:"활기찬 스파크에 청량한 응답,", line2:"차갑게 식힌 한 잔으로!", temp:"ice"},
  ENTP:{line1:"아이디어의 파도를 타고,", line2:"크리스피한 시원함으로 전개하세요.", temp:"ice"},
  ESTJ:{line1:"명확한 결정을 돕는 온기,", line2:"단단하고 깔끔한 따뜻함.", temp:"hot"},
  ESFJ:{line1:"따뜻한 마음에 어울리는 온도,", line2:"부드럽게 함께 머무는 한 잔.", temp:"hot"},
  ENFJ:{line1:"사람과 순간을 잇는 온기,", line2:"마음을 데워주는 따뜻함.", temp:"hot"},
  ENTJ:{line1:"추진력을 위한 집중,", line2:"뜨겁게 정리되는 한 모금.", temp:"hot"}
};

/* 방식 문구 2줄 */
const METHODS={
  M1:{line1:"아메리카노로 즐기세요.", line2:"진한 농도와 긴 여운이 몰입을 더 깊게 해줄 거예요."},
  M2:{line1:"핸드드립으로 즐기세요.", line2:"선명한 향미와 깔끔한 질감이 커피의 진심을 드러내줄 거예요."},
  M3:{line1:"콜드브루로 즐기세요.", line2:"부드럽고 달콤한 여운이 시원하게 하루를 바꿔줄 거예요."}
};
const METHOD_EMOJI={M1:"☕️",M2:"🍵",M3:"🥤"};

/* ===== 폼 진행/유틸 ===== */
const form=document.getElementById('quiz');
const submitBtn=document.getElementById('submit'); /* ← 단 한 번만 선언 */
const prog=document.getElementById('prog');

function updateProgress(){
  let count=0;const required=5;
  const ei=form.querySelector('input[name="mbti-ei"]:checked');
  const ns=form.querySelector('input[name="mbti-ns"]:checked');
  const ft=form.querySelector('input[name="mbti-ft"]:checked');
  const jp=form.querySelector('input[name="mbti-jp"]:checked');
  if(ei&&ns&&ft&&jp)count++;
  if(form.querySelector('input[name="q2"]:checked'))count++;
  if(form.querySelector('input[name="q3"]:checked'))count++;
  if(form.querySelector('input[name="q4"]:checked'))count++;
  if(form.querySelector('input[name="method"]:checked'))count++;
  const pct=Math.round((count/required)*100);
  prog.style.width=pct+'%';
  submitBtn.disabled=count!==required;
}
form.addEventListener('change',updateProgress);updateProgress();

function pairKey(a,b){return[a,b].sort().join('+');}
function dot(hex){return`<span class="dot" style="background:${hex}"></span>`;}
function getMBTI(){
  const ei=form.querySelector('input[name="mbti-ei"]:checked')?.value||'';
  const ns=form.querySelector('input[name="mbti-ns"]:checked')?.value||'';
  const ft=form.querySelector('input[name="mbti-ft"]:checked')?.value||'';
  const jp=form.querySelector('input[name="mbti-jp"]:checked')?.value||'';
  return ei+ns+ft+jp;
}

/* ===== 결과 생성 ===== */
function computeResult(){
  const totals={A:0,B:0,C:0,D:0,E:0,F:0,G:0,H:0};
  ["q2","q3","q4"].forEach(q=>{
    const sel=form.querySelector(`input[name="${q}"]:checked`);
    if(sel){ sel.value.split("").forEach(l=>totals[l]++); }
  });
  const ei=form.querySelector('input[name="mbti-ei"]:checked')?.value;
  const ns=form.querySelector('input[name="mbti-ns"]:checked')?.value;
  const ft=form.querySelector('input[name="mbti-ft"]:checked')?.value;
  const jp=form.querySelector('input[name="mbti-jp"]:checked')?.value;

  if(ei==="E"){totals.F+=0.5;totals.B+=0.5;} else if(ei==="I"){totals.A+=0.5;totals.C+=0.5;}
  if(ns==="N"){totals.D+=0.5;totals.E+=0.5;} else if(ns==="S"){totals.G+=0.5;totals.H+=0.5;}
  if(ft==="F"){totals.B+=0.5;totals.C+=0.5;} else if(ft==="T"){totals.A+=0.5;totals.D+=0.5;}
  if(jp==="J"){totals.F+=0.5;totals.H+=0.5;} else if(jp==="P"){totals.E+=0.5;totals.G+=0.5;}

  const base = Object.keys(totals).reduce((m,k)=>{ m[k]=0; return m; },{});
  const apply=(name,w)=>{ const sel=form.querySelector(`input[name="${name}"]:checked`); if(!sel) return; sel.value.split("").forEach(l=>base[l]+=w); };
  apply('q2',4); apply('q4',3); apply('q3',2);
  if(ei){ (ei==="E"?['F','B']:['A','C']).forEach(l=> base[l]+=0.4); }
  if(ns){ (ns==="N"?['D','E']:['G','H']).forEach(l=> base[l]+=0.4); }
  if(ft){ (ft==="F"?['B','C']:['A','D']).forEach(l=> base[l]+=0.4); }
  if(jp){ (jp==="J"?['F','H']:['E','G']).forEach(l=> base[l]+=0.4); }

  const ordered = Object.keys(totals).sort((a,b)=>{
    if(totals[b]!==totals[a]) return totals[b]-totals[a];
    if(base[b]!==base[a]) return base[b]-base[a];
    return a.localeCompare(b);
  });
  return {top1:ordered[0], top2:ordered[1]};
}

function renderResult(){
  const {top1, top2} = computeResult();
  const T1=TYPES[top1], T2=TYPES[top2];
  const key=pairKey(top1,top2);
  const comboTitle=COMBO_TITLES[key] || `${T1.ko}와 ${T2.ko}의 조합`;
  document.getElementById('combo-title').textContent=comboTitle;

  const mbti=getMBTI();
  const meta=MBTI_TEMP[mbti] || {line1:"오늘의 커피가 어울리는 온도,", line2:"부드럽게 머무는 한 잔.", temp:"hot"};
  document.getElementById('mbti-line').innerHTML = `${meta.line1}<br>${meta.line2}`;

  const methodKey=form.querySelector('input[name="method"]:checked')?.value||"M1";
  const tempEmoji = (methodKey==="M3") ? "❄️" : (meta.temp==="ice" ? "❄️" : "🔥");
  const methodEmoji = METHOD_EMOJI[methodKey];

  document.getElementById('emoji-line').textContent = `${T1.emoji}${T2.emoji}${tempEmoji}${methodEmoji}`;

  const beanCards=document.getElementById('bean-cards');
  beanCards.innerHTML = `
    <div class="bean">
      <p class="bean-title"><span class="dot" style="background:${T1.color}"></span>${T1.ko} · ${T1.en}</p>
      <p class="bean-note">${T1.cup}</p>
    </div>
    <div class="bean">
      <p class="bean-title"><span class="dot" style="background:${T2.color}"></span>${T2.ko} · ${T2.en}</p>
      <p class="bean-note">${T2.cup}</p>
    </div>
  `;

  const m = METHODS[methodKey];
  document.getElementById('method-text').innerHTML = `${m.line1}<br>${m.line2}`;
}

/* ===== 모달 접근성/UX ===== */
const resultEl = document.getElementById('result');
const resultCard = document.getElementById('resultCard');
const againLink = document.getElementById('again');
const closeLink = document.getElementById('close');
const shareLink = document.getElementById('share');
let lastFocused = null;

function lockScroll(lock){ document.documentElement.style.overflow = document.body.style.overflow = lock ? 'hidden' : ''; }
function showModal(){ lastFocused=document.activeElement; resultEl.classList.add('show'); lockScroll(true); (shareLink||resultEl).focus({preventScroll:true}); document.addEventListener('keydown', trapFocus); }
function hideModal(){ resultEl.classList.remove('show'); lockScroll(false); document.removeEventListener('keydown', trapFocus); if(lastFocused?.focus) lastFocused.focus(); }
function trapFocus(e){
  const focusables = resultEl.querySelectorAll('a, button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  if(e.key==='Escape'){ hideModal(); return; }
  if(e.key!=='Tab'||!focusables.length) return;
  const first=focusables[0], last=focusables[focusables.length-1];
  if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
  else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
}
resultEl.addEventListener('click', (e)=>{ if(e.target===resultEl) hideModal(); });

/* ===== 제출 ===== */
submitBtn.addEventListener('click', ()=>{
  const required = [
    ['mbti-ei','mbti-ns','mbti-ft','mbti-jp'],
    ['q2'],['q3'],['q4'],['method']
  ];
  const ok = required.every(g=>{
    if(g.length>1) return g.every(n=> form.querySelector(`input[name="${n}"]:checked`));
    return !!form.querySelector(`input[name="${g[0]}"]:checked`);
  });
  if(!ok){ alert('모든 문항을 선택해주세요.'); return; }
  renderResult(); showModal();
});

/* ===== 다시/닫기 ===== */
againLink.addEventListener('click', (e)=>{ e.preventDefault(); hideModal(); form.reset(); updateProgress(); window.scrollTo({top:0,behavior:'smooth'}); });
closeLink.addEventListener('click', (e)=>{ e.preventDefault(); hideModal(); });

/* ===== 공유: 이미지 + 텍스트/링크 ===== */
async function shareCard(e){
  e.preventDefault();
  // 1) 결과카드 캡처(이미지)
  const canvas = await html2canvas(resultCard, {
    backgroundColor: '#ffffff',
    scale: window.devicePixelRatio < 2 ? 2 : window.devicePixelRatio,
    useCORS: true
  });
  const dataUrl = canvas.toDataURL('image/png');
  const res = await fetch(dataUrl);
  const blob = await res.blob();
  const file = new File([blob], 'ne-coffee-result.png', { type: 'image/png' });

  // 2) 메시지 텍스트(2줄 문구 반영)
  const combo = document.getElementById('combo-title').textContent.trim();
  const mbtiLines = document.getElementById('mbti-line').innerText.trim();
  const methodLines = document.getElementById('method-text').innerText.trim();
  const shareText =
`${combo}
${mbtiLines}
${methodLines}

네,커피 핏팅 테스트`;
  const shareUrl = 'https://linktr.ee/Ne.coffee';

  // 3) Web Share: 파일 + 텍스트 + URL
  if (navigator.canShare && navigator.canShare({ files:[file], text:shareText, url:shareUrl })) {
    try{
      await navigator.share({ files:[file], text:shareText, url:shareUrl, title:'네,커피 핏팅 테스트 결과' });
      return;
    }catch(e){}
  }

  // 4) 파일 공유 미지원 → 텍스트+URL만
  if (navigator.share) {
    try{
      await navigator.share({ text: shareText + '\n' + shareUrl, title:'네,커피 핏팅 테스트 결과' });
      return;
    }catch(e){}
  }

  // 5) 폴백: 링크 복사 + 이미지 저장
  try {
    await navigator.clipboard.writeText(shareText + '\n' + shareUrl);
    alert('공유 문구와 링크를 클립보드에 복사했어요. 채팅창에 붙여넣기 해주세요.');
  } catch(_) {
    alert('공유 문구 복사에 실패했어요. 이미지는 저장되고, 링크는 수동으로 붙여넣어 주세요.');
  }
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ne-coffee-result.png';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  window.open(dataUrl, '_blank');
}
document.getElementById('share').addEventListener('click', shareCard);

/* ===== 배너 6장 순환 ===== */
(function(){
  const imgEl = document.getElementById('bannerImg');
  if(!imgEl) return;

  const BANNERS = ['banner1.jpg','banner2.jpg','banner3.jpg','banner4.jpg','banner5.jpg','banner6.jpg'];
  BANNERS.forEach(src => { const i = new Image(); i.src = src; });

  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.random()* (i+1) | 0; [a[i],a[j]]=[a[j],a[i]]; } return a; }

  let order = null;
  try { order = JSON.parse(sessionStorage.getItem('bannerOrder')||'null'); } catch(_){}
  let idx = parseInt(sessionStorage.getItem('bannerIndex')||'-1',10);

  if(!Array.isArray(order) || order.length !== BANNERS.length || order.some(x=>!BANNERS.includes(x))){
    order = shuffle(BANNERS); idx = -1;
  }
  idx = (idx + 1) % order.length;
  const pick = order[idx];

  imgEl.classList.add('fade-in');
  imgEl.addEventListener('load', ()=> imgEl.classList.add('loaded'), { once:true });
  imgEl.src = pick;

  const altMap = {
    'banner1.jpg':'네,커피 — 햇살 드는 바 테이블',
    'banner2.jpg':'네,커피 — 우드톤 바리스타 존',
    'banner3.jpg':'네,커피 — 라떼 아트가 있는 컵',
    'banner4.jpg':'네,커피 — 드립 장면',
    'banner5.jpg':'네,커피 — 원두와 핸드밀',
    'banner6.jpg':'네,커피 — 전포동 매장 전경'
  };
  if (altMap[pick]) imgEl.alt = altMap[pick];

  if(idx === order.length - 1){
    sessionStorage.setItem('bannerOrder', JSON.stringify(shuffle(BANNERS)));
    sessionStorage.setItem('bannerIndex', '-1');
  }else{
    sessionStorage.setItem('bannerOrder', JSON.stringify(order));
    sessionStorage.setItem('bannerIndex', String(idx));
  }
})();
</script>
</body>
</html>
